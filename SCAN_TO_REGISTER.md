# æ‰«ç å³æ³¨å†ŒåŠŸèƒ½è¯´æ˜

> ğŸ¯ æ–°åŠŸèƒ½ï¼šç”¨æˆ·æ‰«ç åè‡ªåŠ¨æ³¨å†Œå¹¶ç™»å½•ï¼Œæ— éœ€é¢„å…ˆåˆ›å»ºè´¦å·

## ğŸ“‹ æ¦‚è¿°

QRç™»å½•ç°åœ¨æ”¯æŒ**"æ‰«ç å³æ³¨å†Œ"**åŠŸèƒ½ï¼š
- âœ… ç”¨æˆ·æ‰«ç åè‡ªåŠ¨åˆ›å»ºè´¦å·
- âœ… æ— éœ€é¢„å…ˆæ³¨å†Œ
- âœ… é»˜è®¤å¯†ç è‡ªåŠ¨ç”Ÿæˆ
- âœ… Appç«¯éœ€è¦adminæƒé™ç¡®è®¤

---

## ğŸ”‘ ç®¡ç†å‘˜è´¦å·

### é»˜è®¤Adminç”¨æˆ·

åˆ›å»ºæ•°æ®åº“åï¼Œè¿è¡Œè¿ç§»è„šæœ¬ï¼š
```bash
psql -h localhost -U postgres -d rust_frame \
  -f scaffold/migrations/001_local_data.sql
```

**Adminè´¦å·ä¿¡æ¯**ï¼š
- ç”¨æˆ·ID: `admin_001`
- ç”¨æˆ·å: `admin`
- é‚®ç®±: `admin@system.local`
- å¯†ç : `admin123`
- è§’è‰²: `admin`

### ç”ŸæˆAdmin JWT Token

```bash
# æ–¹å¼1: ä½¿ç”¨Pythonè„šæœ¬ï¼ˆæ¨èï¼‰
python3 tests/local/generate_admin_token.py

# æ–¹å¼2: åœ¨Appæ¨¡æ‹Ÿå™¨ä¸­ç‚¹å‡»"ç”Ÿæˆæµ‹è¯•Token"
# ï¼ˆæ³¨æ„ï¼šè„šæœ¬ç”Ÿæˆçš„tokenè§’è‰²æ˜¯adminï¼‰
```

---

## ğŸ”„ ç™»å½•æµç¨‹

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Webç«¯      â”‚         â”‚   åç«¯æœåŠ¡   â”‚         â”‚  Appç«¯      â”‚
â”‚             â”‚         â”‚             â”‚         â”‚ (adminæƒé™) â”‚
â”‚ ç‚¹å‡»ç”ŸæˆQR   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  åˆ›å»ºsessionâ”‚         â”‚             â”‚
â”‚ æ˜¾ç¤ºäºŒç»´ç    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  è¿”å›QRç    â”‚         â”‚             â”‚
â”‚ è¿æ¥WebSocketâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  ç­‰å¾…ç¡®è®¤   â”‚         â”‚             â”‚
â”‚             â”‚         â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ æäº¤ç¡®è®¤è¯·æ±‚  â”‚
â”‚             â”‚         â”‚  æ£€æŸ¥ç”¨æˆ·å­˜åœ¨ â”‚         â”‚ (Admin Token) â”‚
â”‚             â”‚         â”‚  ä¸å­˜åœ¨åˆ™åˆ›å»º â”‚         â”‚             â”‚
â”‚             â”‚         â”‚  ç”Ÿæˆç”¨æˆ·tokenâ”‚         â”‚             â”‚
â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  WebSocket  â”‚         â”‚             â”‚
â”‚  è‡ªåŠ¨ç™»å½•    â”‚         â”‚   æ¨é€token  â”‚         â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯¦ç»†æ­¥éª¤

1. **Webç«¯ç”ŸæˆäºŒç»´ç **
   - åˆ›å»ºsession
   - è¿”å›äºŒç»´ç å›¾ç‰‡

2. **Appç«¯ç¡®è®¤ç™»å½•**
   - å¿…é¡»ä½¿ç”¨adminæƒé™çš„JWT token
   - éªŒè¯tokençš„roleå­—æ®µä¸º"admin"

3. **åç«¯å¤„ç†**
   - éªŒè¯adminæƒé™ âœ…
   - åŸºäºsession_idç”Ÿæˆç”¨æˆ·IDï¼ˆæ ¼å¼ï¼š`qr_user_xxxxxxxx`ï¼‰
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
   - ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºè´¦å· â­
   - ç”ŸæˆWebç«¯JWT token
   - WebSocketæ¨é€ç™»å½•æˆåŠŸ

4. **Webç«¯æ¥æ”¶**
   - WebSocketå®æ—¶æ¨é€
   - è‡ªåŠ¨ç™»å½•æˆåŠŸ
   - è·å–token

---

## ğŸ‘¤ è‡ªåŠ¨æ³¨å†Œçš„ç”¨æˆ·

### ç”¨æˆ·ä¿¡æ¯

- **ç”¨æˆ·ID**: `qr_user_xxxxxxxx`ï¼ˆå‰8ä½session_idï¼‰
- **ç”¨æˆ·å**: ä¸user_idç›¸åŒ
- **é‚®ç®±**: `user_id@qr-login.local`
- **å¯†ç **: `user_id@123456`
- **è§’è‰²**: `user`

### ç¤ºä¾‹

å‡è®¾session_idä¸º `a1b2c3d4-e5f6-7890-abcd-ef1234567890`

è‡ªåŠ¨åˆ›å»ºçš„ç”¨æˆ·ï¼š
- user_id: `qr_user_a1b2c3d4`
- username: `qr_user_a1b2c3d4`
- email: `qr_user_a1b2c3d4@qr-login.local`
- password: `qr_user_a1b2c3d4@123456`

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### æ­¥éª¤1ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
# å¯åŠ¨æ•°æ®åº“
docker run -d --name rust-frame-db \
  -e POSTGRES_DB=rust_frame \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -p 5432:5432 \
  postgres:16-alpine

# è¿è¡Œè¿ç§»
psql -h localhost -U postgres -d rust_frame \
  -f scaffold/migrations/001_create_qr_login_sessions.sql

# æ’å…¥adminç”¨æˆ·
psql -h localhost -U postgres -d rust_frame \
  -f scaffold/migrations/001_local_data.sql
```

### æ­¥éª¤2ï¼šç”ŸæˆAdmin Token

```bash
cd /Users/alex/go/src/pldao/rust-frame

# ç”Ÿæˆadmin JWT token
python3 tests/local/generate_admin_token.py

# å¤åˆ¶è¾“å‡ºçš„token
```

### æ­¥éª¤3ï¼šæµ‹è¯•ç™»å½•

**Webç«¯**ï¼š
```bash
# å¯åŠ¨åç«¯
cargo run -- --backend-port 8080

# æ‰“å¼€æµè§ˆå™¨
open scaffold/examples/qr_login_websocket.html
```

**Appæ¨¡æ‹Ÿå™¨**ï¼š
```bash
# æ‰“å¼€Appæ¨¡æ‹Ÿå™¨
open scaffold/examples/app_simulator.html

# 1. ä»Webç«¯å¤åˆ¶Session ID
# 2. ç²˜è´´åˆ°Appæ¨¡æ‹Ÿå™¨
# 3. ç²˜è´´Admin Token
# 4. ç‚¹å‡»"ç¡®è®¤ç™»å½•"
```

### æ­¥éª¤4ï¼šéªŒè¯

**æŸ¥çœ‹åç«¯æ—¥å¿—**ï¼š
```
[INFO] Admin user admin_001 is confirming QR login
[INFO] Target user_id for login: qr_user_a1b2c3d4
[INFO] User qr_user_a1b2c3d4 does not exist, creating new user (scan-to-register)
[INFO] âœ… New user created successfully: qr_user_a1b2c3d4
[INFO] âœ… User qr_user_a1b2c3d4 logged in via QR code scan
```

**Webç«¯è‡ªåŠ¨æ›´æ–°**ï¼š
```
âœ… ç™»å½•æˆåŠŸï¼
å“åº”æ—¶é—´: 95msï¼ˆå‡ ä¹å®æ—¶ï¼ï¼‰
```

---

## ğŸ”’ å®‰å…¨è¯´æ˜

### Adminæƒé™è¦æ±‚

- åªæœ‰adminè§’è‰²çš„ç”¨æˆ·å¯ä»¥ç¡®è®¤QRç™»å½•
- é˜²æ­¢æ™®é€šç”¨æˆ·æ»¥ç”¨ç¡®è®¤åŠŸèƒ½
- ç¡®ä¿ç™»å½•æµç¨‹çš„å®‰å…¨æ€§

### TokenéªŒè¯

- Admin tokenå¿…é¡»æœ‰æ•ˆ
- Tokenä¸èƒ½è¿‡æœŸ
- è§’è‰²å¿…é¡»æ˜¯"admin"

### é»˜è®¤å¯†ç 

è‡ªåŠ¨åˆ›å»ºçš„ç”¨æˆ·ä½¿ç”¨é»˜è®¤å¯†ç æ ¼å¼ï¼š`{user_id}@123456`

**å»ºè®®**ï¼š
- é¦–æ¬¡ç™»å½•åæç¤ºç”¨æˆ·ä¿®æ”¹å¯†ç 
- æˆ–åœ¨Webç«¯æä¾›"ä¿®æ”¹å¯†ç "åŠŸèƒ½

---

## ğŸ“Š APIå“åº”

### æˆåŠŸå“åº”

```json
{
  "code": 0,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "success": true,
    "message": "Login confirmed successfully",
    "user_id": "qr_user_a1b2c3d4",
    "auto_registered": true
  }
}
```

### å­—æ®µè¯´æ˜

- `user_id`: ç™»å½•ç”¨æˆ·çš„ID
- `auto_registered`: æ˜¯å¦ä¸ºè‡ªåŠ¨æ³¨å†Œçš„ç”¨æˆ·
  - `true`: æœ¬æ¬¡æ‰«ç åˆ›å»ºäº†æ–°ç”¨æˆ·
  - `false`: ç”¨æˆ·å·²å­˜åœ¨ï¼Œæ­£å¸¸ç™»å½•

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡æ‰«ç ï¼ˆè‡ªåŠ¨æ³¨å†Œï¼‰

1. ç”¨æˆ·Aç”ŸæˆäºŒç»´ç 
2. ç”¨æˆ·Bï¼ˆadminï¼‰ç¡®è®¤ç™»å½•
3. ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºç”¨æˆ·Açš„è´¦å·
4. ç”¨æˆ·Aè‡ªåŠ¨ç™»å½•æˆåŠŸ

### åœºæ™¯2ï¼šé‡å¤æ‰«ç ï¼ˆæ­£å¸¸ç™»å½•ï¼‰

1. ç”¨æˆ·Aç¬¬äºŒæ¬¡æ‰«ç 
2. adminç¡®è®¤ç™»å½•
3. ç³»ç»Ÿæ‰¾åˆ°å·²å­˜åœ¨çš„ç”¨æˆ·
4. ç”¨æˆ·Aæ­£å¸¸ç™»å½•

### åœºæ™¯3ï¼šæ— adminæƒé™ï¼ˆæ‹’ç»ï¼‰

1. æ™®é€šç”¨æˆ·å°è¯•ç¡®è®¤ç™»å½•
2. è¿”å›é”™è¯¯ï¼š`code: 1006, msg: æƒé™ä¸è¶³`
3. ç™»å½•å¤±è´¥

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### æ–°å¢æ–‡ä»¶

- `scaffold/migrations/001_local_data.sql` - Adminç”¨æˆ·æ•°æ®
- `tests/local/generate_admin_token.py` - Admin tokenç”Ÿæˆå™¨

### ä¿®æ”¹æ–‡ä»¶

- `scaffold/src/backend/api/qr_login/confirm_login.rs` - æ·»åŠ æƒé™éªŒè¯å’Œè‡ªåŠ¨æ³¨å†Œé€»è¾‘

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Admin Tokenå®‰å…¨æ€§**
   - ä¸è¦æ³„éœ²admin JWT token
   - å®šæœŸæ›´æ¢adminå¯†ç 
   - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¼ºå¯†ç 

2. **é»˜è®¤å¯†ç **
   - è‡ªåŠ¨åˆ›å»ºçš„å¯†ç è¾ƒå¼±
   - å»ºè®®é¦–æ¬¡ç™»å½•æ—¶å¼ºåˆ¶ä¿®æ”¹
   - æˆ–æä¾›å¯†ç é‡ç½®åŠŸèƒ½

3. **ç”¨æˆ·ç®¡ç†**
   - è€ƒè™‘æ·»åŠ ç”¨æˆ·åˆ—è¡¨API
   - æ·»åŠ åˆ é™¤ç”¨æˆ·åŠŸèƒ½
   - æ·»åŠ ç¦ç”¨ç”¨æˆ·åŠŸèƒ½

---

## ğŸ¯ ä¸‹ä¸€æ­¥

- [ ] å®ç°é¦–æ¬¡ç™»å½•ä¿®æ”¹å¯†ç åŠŸèƒ½
- [ ] æ·»åŠ ç”¨æˆ·ç®¡ç†API
- [ ] æ·»åŠ å®¡è®¡æ—¥å¿—ï¼ˆè®°å½•è°ç¡®è®¤äº†å“ªä¸ªsessionï¼‰
- [ ] å®ç°tokenåˆ·æ–°æœºåˆ¶

---

**ç‰ˆæœ¬**: v2.0 - æ‰«ç å³æ³¨å†Œ
**æ›´æ–°æ—¥æœŸ**: 2025-12-31
