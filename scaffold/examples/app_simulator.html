<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appç«¯æ¨¡æ‹Ÿå™¨ - æ‰«ç ç™»å½•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 26px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 25px;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .required {
            color: #e74c3c;
        }

        input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #11998e;
            box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .hint code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        button {
            width: 100%;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(17, 153, 142, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .result-box.show {
            display: block;
        }

        .result-box h3 {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: #666;
        }

        .result-value {
            color: #333;
            word-break: break-all;
            max-width: 60%;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: "ğŸ’¡";
            margin-right: 8px;
        }

        .steps {
            font-size: 13px;
            color: #555;
            line-height: 1.8;
        }

        .steps ol {
            margin-left: 20px;
        }

        .steps li {
            margin-bottom: 8px;
        }

        .token-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .token-actions button {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            margin-top: 0;
        }

        .generated-token {
            background: #e7f3ff;
            border: 2px solid #b3d9ff;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .generated-token.show {
            display: block;
        }

        .generated-token code {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #0066cc;
            word-break: break-all;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± Appç«¯æ¨¡æ‹Ÿå™¨</h1>
        <p class="subtitle">æ¨¡æ‹ŸAppæ‰«ç å¹¶ç¡®è®¤ç™»å½•</p>
        <div class="badge">æµ‹è¯•å·¥å…·</div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="section">
            <div class="section-title">ä½¿ç”¨æ­¥éª¤</div>
            <div class="steps">
                <ol>
                    <li>åœ¨Webç«¯é¡µé¢ç‚¹å‡»"ç”ŸæˆäºŒç»´ç "</li>
                    <li>å¤åˆ¶äºŒç»´ç ä¸­çš„ <code>session_id</code> å€¼</li>
                    <li>ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†</li>
                    <li>ç”Ÿæˆæˆ–è¾“å…¥ App Token</li>
                    <li>ç‚¹å‡»"ç¡®è®¤ç™»å½•"</li>
                </ol>
            </div>
        </div>

        <!-- Session ID -->
        <div class="form-group">
            <label>
                Session ID <span class="required">*</span>
            </label>
            <input
                type="text"
                id="sessionId"
                placeholder="ä¾‹å¦‚: abc-123-def-456"
            >
            <div class="hint">ä»äºŒç»´ç çš„JSONæ•°æ®ä¸­å¤åˆ¶ session_id å­—æ®µ</div>
        </div>

        <!-- App Token -->
        <div class="form-group">
            <label>
                App Token (JWT) <span class="required">*</span>
            </label>
            <textarea
                id="appToken"
                placeholder="è¾“å…¥æˆ–ç”ŸæˆJWT token..."
            ></textarea>
            <div class="token-actions">
                <button type="button" onclick="generateToken()" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    ğŸ² ç”Ÿæˆæµ‹è¯•Token
                </button>
                <button type="button" onclick="pasteToken()" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                    ğŸ“‹ ç²˜è´´Token
                </button>
            </div>
            <div class="generated-token" id="generatedTokenBox">
                <strong>âœ… Tokenå·²ç”Ÿæˆ:</strong>
                <code id="generatedToken"></code>
            </div>
        </div>

        <!-- ç¡®è®¤ç™»å½•æŒ‰é’® -->
        <button onclick="confirmLogin()" id="confirmBtn">
            âœ… ç¡®è®¤ç™»å½•
        </button>

        <!-- çŠ¶æ€æ¶ˆæ¯ -->
        <div class="status" id="status"></div>

        <!-- ç»“æœæ˜¾ç¤º -->
        <div class="result-box" id="resultBox">
            <h3>ğŸ“Š ç™»å½•ç»“æœ</h3>
            <div class="result-item">
                <span class="result-label">çŠ¶æ€:</span>
                <span class="result-value" id="resultStatus">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">æ¶ˆæ¯:</span>
                <span class="result-value" id="resultMessage">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">å“åº”æ—¶é—´:</span>
                <span class="result-value" id="resultTime">-</span>
            </div>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="section" style="margin-top: 20px;">
            <div class="section-title">ğŸ’» è°ƒè¯•ä¿¡æ¯</div>
            <div class="steps">
                <p>æŒ‰ <code>F12</code> æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/v1';

        // ç”Ÿæˆæµ‹è¯•Token
        function generateToken() {
            const tokenEl = document.getElementById('appToken');
            const boxEl = document.getElementById('generatedTokenBox');
            const tokenCodeEl = document.getElementById('generatedToken');

            // ç”Ÿæˆç®€å•çš„JWT tokenï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
            const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
            const payload = btoa(JSON.stringify({
                user_id: 'test_user_001',
                username: 'testuser',
                role: 'user',
                exp: Math.floor(Date.now() / 1000) + 86400,
                iat: Math.floor(Date.now() / 1000)
            }));

            // æ³¨æ„ï¼šè¿™ä¸ªtokençš„ç­¾åæ˜¯ä¼ªé€ çš„ï¼Œå®é™…éœ€è¦åç«¯é…ç½®
            const signature = 'test_signature_' + Math.random().toString(36).substring(7);
            const token = `${header}.${payload}.${signature}`;

            tokenEl.value = token;
            tokenCodeEl.textContent = token;
            boxEl.classList.add('show');

            console.log('âœ… æµ‹è¯•Tokenå·²ç”Ÿæˆ');
            console.log('âš ï¸  æ³¨æ„: è¿™æ˜¯æµ‹è¯•tokenï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦ä»åç«¯è·å–çœŸå®token');
        }

        // ç²˜è´´Token
        async function pasteToken() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('appToken').value = text;
                console.log('âœ… Tokenå·²ç²˜è´´');
            } catch (err) {
                alert('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´');
                console.error('âŒ ç²˜è´´å¤±è´¥:', err);
            }
        }

        // ç¡®è®¤ç™»å½•
        async function confirmLogin() {
            const sessionId = document.getElementById('sessionId').value.trim();
            const appToken = document.getElementById('appToken').value.trim();
            const statusEl = document.getElementById('status');
            const confirmBtn = document.getElementById('confirmBtn');
            const resultBox = document.getElementById('resultBox');

            // éªŒè¯è¾“å…¥
            if (!sessionId) {
                showStatus('error', 'âŒ è¯·è¾“å…¥ Session ID');
                return;
            }

            if (!appToken) {
                showStatus('error', 'âŒ è¯·è¾“å…¥ App Token');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showStatus('loading', 'â³ æ­£åœ¨ç¡®è®¤ç™»å½•...');
            confirmBtn.disabled = true;

            const startTime = Date.now();

            try {
                console.log('ğŸ“¤ å‘é€ç¡®è®¤è¯·æ±‚:', {
                    session_id: sessionId,
                    app_token: appToken.substring(0, 50) + '...'
                });

                const response = await fetch(`${API_BASE}/qr-login/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        app_token: appToken
                    })
                });

                const endTime = Date.now();
                const responseTime = endTime - startTime;

                const data = await response.json();

                console.log('ğŸ“¥ æ”¶åˆ°å“åº”:', data);

                if (data.code === 0) {
                    // æˆåŠŸ
                    showStatus('success', 'âœ… ç™»å½•ç¡®è®¤æˆåŠŸï¼');
                    showResult('æˆåŠŸ', data.msg || 'ç™»å½•æˆåŠŸ', `${responseTime}ms`);

                    // æç¤ºæ£€æŸ¥Webç«¯
                    setTimeout(() => {
                        alert('âœ… ç™»å½•ç¡®è®¤æˆåŠŸï¼\n\nè¯·æŸ¥çœ‹Webç«¯é¡µé¢ï¼Œåº”è¯¥å·²ç»æ˜¾ç¤º"ç™»å½•æˆåŠŸ"çŠ¶æ€ï¼');
                    }, 500);

                } else {
                    // é”™è¯¯
                    showStatus('error', `âŒ ç™»å½•å¤±è´¥: ${data.msg}`);
                    showResult('å¤±è´¥', data.msg || 'æœªçŸ¥é”™è¯¯', `${responseTime}ms`);
                }

            } catch (error) {
                console.error('âŒ è¯·æ±‚å¤±è´¥:', error);
                showStatus('error', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
                showResult('é”™è¯¯', error.message, '-');
            } finally {
                confirmBtn.disabled = false;
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type} show`;
            statusEl.textContent = message;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(status, message, time) {
            const resultBox = document.getElementById('resultBox');
            document.getElementById('resultStatus').textContent = status;
            document.getElementById('resultMessage').textContent = message;
            document.getElementById('resultTime').textContent = time;
            resultBox.classList.add('show');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ç”Ÿæˆtoken
        window.addEventListener('load', () => {
            console.log('ğŸ“± Appç«¯æ¨¡æ‹Ÿå™¨å·²åŠ è½½');
            console.log('ğŸ”— APIåœ°å€:', API_BASE);
            generateToken();
        });
    </script>
</body>
</html>
